<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2320"/>

<div>
<span><div>一个简单的使用v8接口例子流程： V8_Helloword</div><div><span style="font-size: 24px; font-weight: bold;">1.初始化v8相关资源</span></div><ul><li><span style="color: rgb(0, 0, 255); font-family: NSimSun;">v8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">V8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(136, 0, 0); font-family: NSimSun;">InitializeICUDefaultLocation</span>  //ICU库是一个支持国际化，本地语言化的软件库</li><li><span style="color: rgb(0, 0, 255); font-family: NSimSun;">v8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">V8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(136, 0, 0); font-family: NSimSun;">InitializeExternalStartupData</span> //加载 natives_blob 和 snapshot_blob。可以加载当前目录，也可以手动指定目录，或者是直接内存加载。</li><li><span style="color: rgb(0, 0, 255); font-family: NSimSun;">v8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">platform</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(136, 0, 0); font-family: NSimSun;">NewDefaultPlatform</span> //平台相关底层基础支持初始化。比较重要的就是:</li><li style="list-style: none; display: inline"><ul><li><span style="list-style: none;">依赖的任务线程模型</span></li><li><span style="list-style: none;">还有一些dump收集的</span></li><li><span style="list-style: none;">内存分配：<span style="color: rgb(0, 0, 255); font-family: NSimSun;">OS</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(136, 0, 0); font-family: NSimSun;">Allocate</span></span></li></ul></li><li><span style="color: rgb(0, 0, 255); font-family: NSimSun;">v8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">V8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(136, 0, 0); font-family: NSimSun;">InitializePlatform</span></li><li style="list-style: none; display: inline"><ul><li><span style="list-style: none;"><span style="color: rgb(0, 0, 255); font-family: NSimSun;">static</span> <span style="color: rgb(0, 0, 255); font-family: NSimSun;">v8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">Platform</span><span style="font-family: NSimSun;">*</span> <span style="color: rgb(0, 0, 128); font-family: NSimSun;">platform_</span><span style="font-family: NSimSun;">;</span><span style="color: rgb(136, 0, 0); font-family: NSimSun;"> //</span><span style="font-family: NSimSun;">储存平台相关全局类</span></span></li><li><span style="color: rgb(0, 0, 255); font-family: NSimSun;">v8</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">base</span><span style="font-family: NSimSun;">::</span><span style="color: rgb(136, 0, 0); font-family: NSimSun;">SetPrintStackTrace  //开启栈跟踪</span></li><li>trace   <span style="color: rgb(0, 0, 255); font-family: NSimSun;">v8::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">tracing::</span><span style="color: rgb(0, 0, 255); font-family: NSimSun;">TracingCategoryObserver</span></li></ul></li></ul><div align="left" style="min-height: 11pt;"><ul><li><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">v8</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">V8</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">Initialize</span></div></li><li style="list-style: none; display: inline"><ul><li><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><span style="list-style: none;"><span style="font-size: 9pt; font-family: NSimSun;">各种环境初始化 <span style="font-size: 9pt; font-family: NSimSun; color: rgb(136, 0, 0);">InitializeOncePerProcess  <span style="font-size: 9pt; font-family: NSimSun; color: rgb(50, 135, 18);">// lazy 单例</span></span></span></span></div></div></li><li style="list-style: none; display: inline"><ul><li><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><span style="list-style: none;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">Isolate</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">InitializeOncePerProcess <span style="font-size: 9pt; color: rgb(50, 135, 18); font-family: NSimSun;">//Isolate对应的 tlsley初始化</span></span></span></div></div></li><li style="list-style: none; display: inline"><ul><li><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><span style="list-style: none;"><span style="font-size: 9pt; font-family: NSimSun;"> </span> <span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">static</span> <span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">base</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">Thread</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">LocalStorageKey</span> <span style="font-size: 9pt; color: rgb(0, 0, 128); font-family: NSimSun;">per_isolate_thread_data_key_</span><span style="font-size: 9pt; font-family: NSimSun;">;</span></span></div></div></div></div></li><li><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; font-family: NSimSun;"> </span> <span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">static</span> <span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">base</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">Thread</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">LocalStorageKey</span> <span style="font-size: 9pt; color: rgb(0, 0, 128); font-family: NSimSun;">isolate_key_</span><span style="font-size: 9pt; font-family: NSimSun;">;</span></div></div></div></div></li><li><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; font-family: NSimSun;"> </span> <span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">static</span> <span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">base</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">Thread</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">LocalStorageKey</span> <span style="font-size: 9pt; color: rgb(0, 0, 128); font-family: NSimSun;">thread_id_key_</span><span style="font-size: 9pt; font-family: NSimSun;">;</span></div></div></div></div></li></ul></li><li><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">sampler</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">Sampler</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">SetUp</span><span style="font-size: 9pt; font-family: NSimSun;">()  <span style="font-size: 9pt; font-family: NSimSun; color: rgb(50, 135, 18);">//采集器  用于后续的执行分析</span></span></div></div></div></div></li><li><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">CpuFeatures</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">Probe</span><span style="font-size: 9pt; font-family: NSimSun;">(</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">false） </span><span style="font-size:9pt"><span style="font-size: 9pt; color: rgb(50, 135, 18); font-family: NSimSun;">//跟踪目标CPU支持的，特殊指令集合，在需要的时候替换生成的指令代码</span></span></div></li><li><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">ElementsAccessor</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">InitializeOncePerProcess</span></div></li><li style="list-style: none; display: inline"><ul><li><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><span style="list-style: none;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">static</span> <span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">ElementsAccessor</span><span style="font-size: 9pt; font-family: NSimSun;">**</span> <span style="font-size: 9pt; color: rgb(0, 0, 128); font-family: NSimSun;">elements_accessors_</span><span style="font-size: 9pt; font-family: NSimSun;">;   <span style="font-size: 9pt; font-family: NSimSun; color: rgb(50, 135, 18);">//管理各种类型元素的统一访问接口</span></span></span></div></div></li></ul></li><li><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">Bootstrapper</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">InitializeOncePerProcess </span><span style="font-size:9pt"><span style="font-size: 9pt; color: rgb(50, 135, 18); font-family: NSimSun;">//(Extension) The Boostrapper is the public interface for creating a JavaScript global context </span></span></div></li><li><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">CallDescriptors</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">InitializeOncePerProcess</span><span style="font-size: 9pt; font-family: NSimSun;">() <span style="font-size: 9pt; font-family: NSimSun; color: rgb(50, 135, 18);">//CallInterfaceDescriptor 有很多，看起来是寄存器相关？，后面需要时再看。</span></span></div></li><li><div align="left" style="min-height: 11pt;"><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">wasm</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">WasmEngine</span><span style="font-size: 9pt; font-family: NSimSun;">::</span><span style="font-size: 9pt; color: rgb(136, 0, 0); font-family: NSimSun;">InitializeOncePerProcess</span><span style="font-size: 9pt; font-family: NSimSun;">() <span style="font-size: 9pt; font-family: NSimSun; color: rgb(50, 135, 18);">//WASMcode 执行相关</span></span></div></li></ul></li></ul></li></ul><div><br/></div><div><span style="font-size: 24px; font-weight: bold;">2.solate相关</span></div><div><br/></div><div><div><b><span style="font-size: 24px;">2.1 Isolate 的初始化创建详细过程</span></b></div><div>一个Isolate对应了一个V8的实例，拥有完整的堆栈和Heap。</div><div>一个Isolate是一份独立的V8 runtime，包括Heap管理器，垃圾回收器。</div><div><span style="color: rgb(255, 0, 0);"><b>在一个时间段内，有且只有一个线程能使用此Isolate。不过多个线程可以同时使用多个Isolate。(2.2和2.3会介绍这个点)</b></span></div><div>单独的Isolate是不足以运行脚本的，我们在此需要一个全局变量。Context就是提供全局变量的工具。它在所处在的Isolate管理的Heap中创建一个对象，并以此为全局变量构建出一个完整的执行环境，供脚本使用。因此对于一个Isolate不仅可以用于多个Context，而且可以在这些Context之间共享对象。</div><div><img src="V8_Helloword_files/Image.png" type="image/png" style="height: auto;"/></div><div><span style="font-family: 微软雅黑;">v8::Isolate</span></div><ul><li><span style="font-family: 微软雅黑;">v8::internal::Isolate</span></li><li><span style="font-family: 微软雅黑;">v8::internal::ThreadManager</span></li><li><span style="font-family: 微软雅黑;">v8::internal::HandleScopeData</span></li><li><span style="font-family: 微软雅黑;">v8.internal.Heap</span></li><li><div align="left" style="min-height: 11pt;"><span style="font-family: 微软雅黑;"><font color="#2B91AF">Logger</font>* logger_;</span></div></li><li><div align="left" style="min-height: 11pt;"><span style="font-family: 微软雅黑;"><font color="#2B91AF">Debug</font>* debug_;</span></div></li><li><div align="left" style="min-height: 11pt;"><span style="font-family: 微软雅黑;">std::<font color="#2B91AF">unique_ptr</font>&lt;<font color="#2B91AF">TracingCpuProfilerImpl</font>&gt; tracing_cpu_profiler_;</span></div></li><li><span style="font-family: 微软雅黑;">v8.internal.Isolate.PerIsolateThreadData</span></li></ul><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);"><br/></span></span></span></div><div>v8::Isolate 初始化</div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">     Isolate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">*</span></font>  <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">v8</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Isolate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">New</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">const</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Isolate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">CreateParams</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&amp;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>params</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">)</span></font></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">          Isolate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">*</span></font> <font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Allocate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">          void<span style="color: rgb(136, 0, 0);"> </span></span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Initialize</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Isolate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">*</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>isolate</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">,</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">const</span></font> <font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">CreateParams</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&amp;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>params</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">)</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><br/></span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;">v8::internal::Isolate</span></span></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">     bool </span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Init</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">StartupDeserializer</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">*</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>des</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">);</span></font></div></div></div></div></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);"> </span></span></span></div><div><b><span style="font-size: 19px;">2.1.1 初始化 </span></b></div><div align="left" style="min-height: 11pt;"><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>&gt;    v8.dll!v8::internal::ThreadManager::ThreadManager() 行 248    C++</div><div>     v8.dll!v8::internal::Isolate::Isolate() 行 2532    C++</div><div>     v8.dll!v8::Isolate::New(const v8::Isolate::CreateParams &amp; params={...}) 行 8552    C++</div><div>     v8_hello_world.exe!main(int argc, char * * argv=0x000000000053f470) 行 24    C++</div><div>     v8_hello_world.exe!invoke_main() 行 79    C++</div><div>     v8_hello_world.exe!__scrt_common_main_seh() 行 283    C++</div><div>     v8_hello_world.exe!__scrt_common_main() 行 326    C++</div><div>     v8_hello_world.exe!mainCRTStartup() 行 17    C++</div><div>     kernel32.dll!00000000773c59cd()    未知</div><div>     ntdll.dll!000000007762383d()    未知</div></div><div>Isolate 创建时，用一个静态变量来记录v8创建了多少个实例</div><div align="left" style="min-height: 11pt;"><img src="V8_Helloword_files/Image [1].png" type="image/png" style="height: auto;"/></div><div><br/></div><div>ThreadManager 用于Isolate多线程被调用的管理类</div><div><img src="V8_Helloword_files/Image [2].png" type="image/png" style="height: auto;"/></div><div><br/></div><div><span style="font-size: 19px;"><b>2.1.2 </b><b>HandleScopeData   存放js相关所有对象</b></span></div><div><img src="V8_Helloword_files/Image [3].png" type="image/png" style="height: auto;"/></div><div><br/></div><div><span style="font-size: 19px;"><b>2.1.3</b> <b>加载本地文件 SetEmbeddedBlob  （快照机制）</b></span></div><div><img src="V8_Helloword_files/Image [4].png" type="image/png" style="height: auto;"/></div><div><br/></div><div><span style="font-size: 24px;"><span style="font-size: 24px; font-weight: bold;">2.2 一个线程如何可以支持多个Isolate交替运行</span></span></div><div>这里就需要类似于压栈和出栈的机制。</div><div>来保存和还原Isolate 运行以来的数据，这里主要是 TLS相关和v8.internal.Isolate.PerIsolateThreadData 相关</div><div>v8::internal::Isolate::EntryStackItem  实现栈的逻辑 </div><div><img src="V8_Helloword_files/Image [5].png" type="image/png" style="height: auto;"/></div><div>内部实现原理关键代码如下：  一般式结合以下2个逻辑现</div><div>v8.internal.Isolate.Enter</div><div><img src="V8_Helloword_files/Image [6].png" type="image/png" style="height: auto;"/></div><div>v8.internal.Isolate.Exit </div><div><img src="V8_Helloword_files/Image [7].png" type="image/png" style="height: auto;"/></div></div><div align="left" style="min-height: 11pt;"><div><b><span style="font-size: 24px;"><br/></span></b></div><div><span style="font-size: 24px; font-weight: bold;">2.3 如何保证多线程安全Isolate的运行</span></div><div><div align="left" style="min-height: 11pt;"><div>v8是支持多线程的，但是v8 isolate一次只能在一个线程中使用。这里的使用包括，访问v8handle或者持有指向v8内部对象的对象指针。这需要调用者的保证，可以按需选择是否需要加锁。出了可以使用任何其他的同步机制外，<span style="color: rgb(255, 0, 0);"><b>还必须使用v8::locker 和 v8::Unlocker来</b></span>保证v8被切换到单线程执行。</div><div><br/></div><div>     下面详细分析一下，V8内部是如何加锁限制，一个ISolate在同一时刻只在一个线程执行。同时1个ISolate又可以在互斥的时间段，在不同的线程中执行。</div><div><br/></div><div>     1）首先考虑，仅仅在一个线程中执行时，v8.Isolate.Scope 会在指定的作用域内，调用v8.internal.Isolate.Enter和v8.internal.Isolate .Exit。然后其内部依靠，线程级别的全局记录+  链表EntryStackItem 结构记录调用栈 (Isolte,PerIsolateThreadData)。实现了，当线程正在执行某个Isolate时，把之前的信息压栈保护。作用域失效时，恢复为原始Isolate环境。详细见2.2的内容。</div><div><br/></div><div>     2）如果一个线程正在使用Isolate，其他线程如果也调用该Isolate, 需要遵守<span style="color: rgb(255, 0, 0);"><b>V8的规范，v8::locker 和 v8::Unlocker</b></span>。</div><div>其内部本质上是一个类似临界区实现，同一线程可以重复进入，内部实际用的是不支持递归调用的读写锁(<font color="#880000" face="NSimSun"><i>AcquireSRWLockExclusive).</i></font></div><div>如代码所示：用读写锁的独占模式，而且读写锁的独占模式，不支持递归调用。不允许同一个线程多次Acquire，会直接卡主不会报错。</div><div><img src="V8_Helloword_files/Image [8].png" type="image/png" style="height:auto;" width="142"/></div><div>     3）所以实际流程如下，当某个线程需要加锁前，<font face="NSimSun"><b><span style="color: rgb(0, 0, 128);">isolate</span></b>根据其内部成员</font><font face="NSimSun"><span style="color: rgb(136, 0, 0);">thread_manager</span>中管理了当前正在被哪个线程独占。</font></div><div><span style="font-family: NSimSun;">如果发现是已经被lock,就会跳过，否则同一个线程中重复调用不支持递归的锁，就会直接卡死。</span></div><div><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);"><br/></span></span></div><div><hr/></div><div><font color="#0000FF" face="NSimSun">reinterpret_cast</font><font face="NSimSun">&lt;</font><font color="#0000FF" face="NSimSun">i</font><font face="NSimSun">::</font><font color="#0000FF" face="NSimSun">Isolate</font><font face="NSimSun">*&gt;(</font><font color="#000080" face="NSimSun"><b>isolate</b></font><font face="NSimSun">)</font></div><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div>然后调用 <font face="NSimSun"><span style="color: rgb(136, 0, 0);">thread_manager</span> 进行相应的lock</font></div><div align="left" style="min-height: 11pt;"><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><br/></span></span></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">if</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">(!</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">isolate_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">-&gt;</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">thread_manager</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">()-&gt;</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">IsLockedByCurrentThread</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">()) {</span></font></div><div align="left" style="min-height: 11pt;margin-left:40px;"><font face="NSimSun" size="1"><span style="font-size:9pt">   </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">isolate_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">-&gt;</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">thread_manager</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">()-&gt;</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Lock</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">   </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">has_lock_</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">=</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">true</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;">     ...</span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;">     }</span></span></div></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><br/></span></span></div><div><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">bool </span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">IsLockedByCurrentThread</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">() {</span></font></div></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">   </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">return</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">mutex_owner_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Equals</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">ThreadId</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Current</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">());</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">  }</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><br/></span></span></div></div></div></div><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">void</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">ThreadManager</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Lock</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">() {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">mutex_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Lock</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">mutex_owner_</span></font> <font color="#008080" face="NSimSun" size="1"><span style="font-size:9pt">=</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">ThreadId</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Current</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#A000A0" face="NSimSun" size="1"><span style="font-size:9pt">DCHECK</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">IsLockedByCurrentThread</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">());</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">}</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><br/></span></span></div></div><div align="left" style="min-height: 11pt;"><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">void</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">ThreadManager</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Unlock</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">() {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">mutex_owner_</span></font> <font color="#008080" face="NSimSun" size="1"><span style="font-size:9pt">=</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">ThreadId</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Invalid</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">mutex_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Unlock</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">}</span></font></div></div></div><hr/><div align="left" style="min-height: 11pt;"><div><span style="color: rgb(0, 128, 0);"><span style="font-size: 12px;"><span style="font-family: NSimSun;">//v8\include\v8.h 中</span></span></span></div><div><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt">/**</span></font></div></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * Multiple threads in V8 are allowed, but only one thread at a time is allowed</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * to use any given V8 isolate, see the comments in the Isolate class. The</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * definition of 'using a V8 isolate' includes accessing handles or holding onto</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * object pointers obtained from V8 handles while in the particular V8 isolate.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * It is up to the user of V8 to ensure, perhaps with locking, that this</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * constraint is not violated. In addition to any other synchronization</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * mechanism that may be used, the v8::Locker and v8::Unlocker classes must be</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * used to signal thread switches to V8.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * v8::Locker is a scoped lock object. While it's active, i.e. between its</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * construction and destruction, the current thread is allowed to use the locked</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * isolate. V8 guarantees that an isolate can be locked by at most one thread at</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * any time. In other words, the scope of a v8::Locker is a critical section.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * Sample usage:</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt">* \code</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * ...</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * {</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   v8::Locker locker(isolate);</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   v8::Isolate::Scope isolate_scope(isolate);</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   ...</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   // Code using V8 and isolate goes here.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   ...</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * } // Destructor called here</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * \endcode</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * If you wish to stop using V8 in a thread A you can do this either by</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * destroying the v8::Locker object as above or by constructing a v8::Unlocker</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * object:</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * \code</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * {</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   isolate-&gt;Exit();</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   v8::Unlocker unlocker(isolate);</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   ...</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   // Code not using V8 goes here while V8 can run in another thread.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   ...</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * } // Destructor called here.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * isolate-&gt;Enter();</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * \endcode</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * The Unlocker object is intended for use in a long-running callback from V8,</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * where you want to release the V8 lock for other threads to use.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * The v8::Locker is a recursive lock, i.e. you can lock more than once in a</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * given thread. This can be useful if you have code that can be called either</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * from code that holds the lock or from code that does not. The Unlocker is</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * not recursive so you can not have several Unlockers on the stack at once, and</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * you can not use an Unlocker in a thread that is not inside a Locker's scope.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * An unlocker will unlock several lockers if it has to and reinstate the</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * correct depth of locking on its destruction, e.g.:</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * \code</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * // V8 not locked.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * {</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   v8::Locker locker(isolate);</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   Isolate::Scope isolate_scope(isolate);</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   // V8 locked.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   {</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *     v8::Locker another_locker(isolate);</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *     // V8 still locked (2 levels).</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *     {</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *       isolate-&gt;Exit();</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *       v8::Unlocker unlocker(isolate);</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *       // V8 not locked.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *     }</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *     isolate-&gt;Enter();</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *     // V8 locked again (2 levels).</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   }</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> *   // V8 still locked (1 level).</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * }</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * // V8 Now no longer locked.</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> * \endcode</span></font></div><div align="left" style="min-height: 11pt;"><font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt"> */</span></font></div></div><div><b><span style="font-size: 24px;"><br/></span></b></div><div><span style="font-size: 24px; font-weight: bold;">3 Isolate如何进行简单的编译和执行</span></div></div><div><br/></div><div>     首先Isloate 实例创建完毕后。在考虑了多线程安全执行的因数后。现在可以单线程中。</div><div>V8的实例是如何开始初始化环境，然后进行编译个执行脚本代码。</div><div>     正如前面2.2和2.3所示，首先是要进入Isolate的执行环境</div><div><br/></div><div><b><span style="font-size: 24px;">3.1 v8 执行环境准备</span></b></div><div>     v8::Isolate::Scope  用于Isolate在栈上的相关信息保存。Isolate可以被多线程执行，以及单个线程可以在多个Isolate中切换交替运行。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>        {</div><div>            v8::Isolate::Scope isolate_scope(isolate);</div><div>            ...</div><div>        }</div></div><div><br/></div><div>      Context创建用于js执行的上下文，拥有其内置函数和对象，可以类似压栈和出栈在不痛的context中切换；v8::HandleScope用于统一存储存储栈上申请的handle，在其释放后，gc会统一释放其持有的对象。如果要申请非栈生命周期使用的，需要使用与local对应的Persistent。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>        // Create a stack-allocated handle scope.</div><div>        v8::HandleScope handle_scope(isolate);// Create a new context.</div><div>        v8::Local&lt;v8::Context&gt; context = v8::Context::New(isolate);</div><div><br/></div><div>        // Enter the context for compiling and running the hello world script.</div><div>        v8::Context::Scope context_scope(context);</div></div><div><br/></div><div>然后就是编译和执行，后面会继续详细分析编译和执行的流程（<span style="color: rgb(255, 0, 0);"><b>重点关注缓存相关逻辑</b></span>）。</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>     {</div><div>      // Create a string containing the JavaScript source code.</div><div>      v8::Local&lt;v8::String&gt; source =</div><div>        v8::String::NewFromUtf8(isolate, &quot;'Hello' + ', World!'&quot;,</div><div>          v8::NewStringType::kNormal)</div><div>        .ToLocalChecked();</div><div><br/></div><div>      // Compile the source code.</div><div>      v8::Local&lt;v8::Script&gt; script =</div><div>        v8::Script::Compile(context, source).ToLocalChecked();</div><div><br/></div><div>      // Run the script to get the result.</div><div>      v8::Local&lt;v8::Value&gt; result = script-&gt;Run(context).ToLocalChecked();</div><div><br/></div><div>      // Convert the result to an UTF8 string and print it.</div><div>      v8::String::Utf8Value utf8(isolate, result);</div><div>      printf(&quot;%s\n&quot;, *utf8);</div><div>     }</div></div></span>
</div></body></html> 