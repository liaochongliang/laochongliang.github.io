<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2444"/>

<div>
<span><div align="left" style="min-height: 11pt;"><div><b><span style="font-size: 24px;">V8_线程模型（一）</span></b></div><div><span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">DefaultWorkerThreadsTaskRunner</span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);"><br/></span></span></span></div><div><img src="v8_Threadlpool_01_files/Image.png" type="image/png" style="height: auto;"/></div><div><br/></div><div><hr/></div><div>1.常规的用队列+信号量，来构成线程池。 对外走统一的接口，postTask.</div><div><br/></div><div>2.最终把能力在 Platform层对外暴露 
<div align="left" style="min-height: 11pt;"><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">void</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">DefaultPlatform</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">CallOnWorkerThread</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>unique_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Task</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>task</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">) {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">EnsureBackgroundTaskRunnerInitialized</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">worker_threads_task_runner_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">-&gt;</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">PostTask</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">move</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>task</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">));</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">}</span></font></div><div align="left" style="min-height: 11pt;"><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>shared_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">DefaultWorkerThreadsTaskRunner</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">worker_threads_task_runner_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div></div></div></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);"> </span></span></span></div><div><hr/></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">DefaultWorkerThreadsTaskRunner</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">DefaultWorkerThreadsTaskRunner</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font></div></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">   </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">uint32_t</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>thread_pool_size</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">) {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">for</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">uint32_t</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>i</b></span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">= 0;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>i</b></span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>thread_pool_size</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">; ++</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>i</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">) {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">   </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">thread_pool_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt"><i>push_back</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">make_unique</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">WorkerThread</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;(&amp;</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">));</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">  }</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">}</span></font></div><div><img src="v8_Threadlpool_01_files/Image [1].png" type="image/png" style="height: auto;"/></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><br/></span></span></div><div align="left" style="min-height: 11pt;"><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">DefaultWorkerThreadsTaskRunner</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">{</span></span></span></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt">// v8::TaskRunner implementation.</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">void</span></font> <font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">PostTask</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>unique_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Task</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>task</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">)</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">override</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">private：</span></span></span></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">     bool </span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">terminated_</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">=</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">false</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">     base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Mutex </span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">lock_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">     TaskQueue </span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">     std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>vector</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>unique_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">WorkerThread</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">thread_pool_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">}</span></span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">    </span></span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">     --</span></span></span><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">thread_pool_</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 128);">          --</span></span></span><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">WorkerThread（</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Thread</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">）</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">          {</span></span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">     </span></span></span>        <span style="color: rgb(0, 0, 255); font-family: NSimSun; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); display: inline !important; float: none;">private：</span></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">               TaskQueue</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">*</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">          }   </span></span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">     </span></span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">     --</span></span></span><font color="#0000FF" face="NSimSun" size="2">TaskQueue</font></div><div><span style="font-size: 12px;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">          {</span></span></span></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">               base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Semaphore </span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">process_queue_semaphore_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">              </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Mutex</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">lock_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">              </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>queue</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>unique_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Task</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">task_queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div><span style="font-size: 12px;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 255);">          }</span></span></span></div></div><div align="left" style="min-height: 11pt;"><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><span style="color: rgb(0, 0, 128);"><br/></span></span></span></div><div><hr/></div><div><span style="color: rgb(255, 0, 0);"><span style="font-family: 微软雅黑;"><b><span style="font-size: 24px;">关注-退出时刻的逻辑：</span></b></span></span></div><div style="display: block; margin: 0px; padding: 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="font-size: medium;">1.加锁互斥调用，关闭新的任务加入。</span></div><div align="left" style="min-height: 11pt;"><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">void</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">DefaultWorkerThreadsTaskRunner</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">PostTask</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>unique_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Task</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>task</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">) {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">LockGuard</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Mutex</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>guard</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(&amp;</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">lock_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">);</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">if</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">terminated_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">)</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">return</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Append</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">move</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>task</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">));</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">}</span></font></div><div><br/></div><div>2.<span style="font-size: 9pt; color: rgb(0, 0, 255); font-family: NSimSun;">DefaultWorkerThreadsTaskRunner </span>基本所有的函数都加锁调用（除了构造函数）</div></div></div><div style="display: block; margin: 0px; padding: 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div><div><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">void</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">DefaultWorkerThreadsTaskRunner</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Terminate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">() {</span></font></div></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">LockGuard</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Mutex</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>guard</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(&amp;</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">lock_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">);</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">terminated_</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">=</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">true</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Terminate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#008000" face="NSimSun" size="1"><span style="font-size:9pt">// Clearing the thread pool lets all worker threads join.</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">thread_pool_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt"><i>clear</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">}</span></font></div></div><div align="left" style="min-height: 11pt;"><div align="left" style="min-height: 11pt;"><div><br/></div></div><div align="left" style="min-height: 11pt;"><div>3.锁没有锁函数调用，都是对本象中元素进行处理，吐给外层。</div><div align="left" style="min-height: 11pt;"><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>unique_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Task</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">TaskQueue</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">GetNext</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">() {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt"> </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">for</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">(;;) {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">    {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">     </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">LockGuard</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">base</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Mutex</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>guard</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(&amp;</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">lock_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">);</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">     </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">if</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">(!</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">task_queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt"><i>empty</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">()) {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">       </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt"><i>unique_ptr</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&lt;</span></font><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">Task</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">&gt;</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>result</b></span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">=</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">std</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">move</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">task_queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt"><i>front</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">());</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">       </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">task_queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt"><i>pop</i></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">       </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">return</span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt"><b>result</b></span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">      }</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">     </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">if</span></font> <font face="NSimSun" size="1"><span style="font-size:9pt">(</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">terminated_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">) {</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">       </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">process_queue_semaphore_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Signal</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">       </span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">return</span></font> <font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">nullptr</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">;</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">      }</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">    }</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">   </span></font> <font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">process_queue_semaphore_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Wait</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">();</span></font></div><div align="left" style="min-height: 11pt;"><font face="NSimSun" size="1"><span style="font-size:9pt">  }</span></font></div><div align="left" style="min-height: 11pt;"><div><font face="NSimSun" size="1"><span style="font-size:9pt">}</span></font></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;"><br/></span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;">4.最终退出时，会把</span></span><span style="font-size: 9pt;"><span style="font-family: NSimSun;">所有投递的Task干完。当没有任务，又置为结束时，会</span></span><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">process_queue_semaphore_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Signal</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">() </span></font><span style="font-size: 9pt;"><span style="font-family: NSimSun;">接力传递下去，然后本线程退出。 </span></span></div><div><span style="font-size: 9pt;"><span style="font-family: NSimSun;">当</span></span><font color="#0000FF" face="NSimSun" size="1"><span style="font-size:9pt">DefaultWorkerThreadsTaskRunner</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">::</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Terminate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">() 时，</span></font><font color="#000080" face="NSimSun" size="1"><span style="font-size:9pt">queue_</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">.</span></font><font color="#880000" face="NSimSun" size="1"><span style="font-size:9pt">Terminate</span></font><font face="NSimSun" size="1"><span style="font-size:9pt">()，会给信号量+1，然后每个线程在退出时，会继续接力+1。</span></font></div></div></div></div></div></div></div></span>
</div></body></html> 