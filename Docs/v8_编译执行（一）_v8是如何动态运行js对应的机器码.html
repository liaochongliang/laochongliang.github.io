<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2556"/>

<div>
<span><div style="box-sizing: border-box; margin: 10px 0px; font-style: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: 500;"><div style="box-sizing: border-box; margin: 0px 0px 10px; font-style: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: 500;"><div><span style="font-size: 24px;"><span style="font-weight: normal;"><b>1.JavaScript解释型语言会经过以下几个步骤:</b></span></span></div><div><span style="font-weight: normal;">源代码===&gt;预解释(读入代码块-&gt;语法分析-&gt;声明预处理-&gt;定义赋值)</span></div><div><span style="font-weight: normal;">          ===&gt;</span><span style="font-weight: normal;">执行(继续运行下一个代码块)===&gt;结束</span> <span style="font-weight: normal;"> </span></div><div><span style="font-weight: normal;">     1.1 分词/词法分析: 将一连串字符打断成有意义的片段，称为 token.</span></div><div><span style="font-weight: normal;">     1.2 解析: 将 token 的流 (数组) 转换为一个嵌套元素的树，综合地表示程序语言结构，这棵树称为 “抽象语法树” (AST)</span></div><div><span style="font-weight: normal;">     1.3 代码生成: 将这个抽象语法树转换为可执行的代码. 生成的可执行代码根椐目标平台，而有不同</span></div></div><div><span style="font-size: 24px;"><b>2.先看下简单点的过程</b></span></div><div>在<a href="https://liaochongliang.github.io/lcl/Docs/V8_Helloword.html">前文</a>的基础上，修改编译的脚本字符串，去加深理解V8js引擎的执行过程。</div><div>V8会把源码进行解析，然后生成对应平台上的汇编。</div><div>V8编译执行的简单流程（先不考虑JIT）  jscode → AST → ByteCode → 动态生成对应平台机器码。</div><div><span style="color: rgb(255, 0, 0);"><b>我们想在代码调试中去观察这一现象</b></span></div><div><br/></div><div><b><span style="font-size: 21px;">2.1 直接调比较麻烦</span></b></div><div>因为进入JS虚拟机执行后，全是汇编了。 相当于调试一个虚拟机内部的东西。</div><div>这里<span style="color: rgb(255, 0, 0);"><b>采用取巧的办法，写个wille(1)死循环的JS</b></span>。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>      v8::Local&lt;v8::String&gt; source =</div><div>        v8::String::NewFromUtf8(isolate, &quot;\</div><div>          function print(a){return 'hello'+a} \</div><div>          while(1){ \</div><div>          print(88888888)}\</div><div>          &quot;,</div><div>          v8::NewStringType::kNormal)</div><div>        .ToLocalChecked();</div></div><div><span style="color: rgb(51, 51, 51);"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="font-size: 12px;"><br/></span></span></span></div><div>然后执行起来，走到死循环后，<span style="color: rgb(255, 0, 0);"><b>在中断</b></span>，观察正在执行的汇编。</div><div>也就是图中左上角黄色箭头指示的地方，<span style="color: rgb(255, 0, 0);"><b>会在cmp xxx 和 ja xxx 死循环</b></span>。</div></div><div><img src="v8_编译执行（一）_v8是如何动态运行js对应的机器码_files/Image.png" type="image/png" style="height: auto;"/></div><div><br/></div><div><b><span style="font-size: 21px;">2.2 用D8针对同样的JS进行对比</span></b></div><div>生成的机器码（均是X64平台），见左下角notepad++所示。</div><div>与右上角的实际运行的机器码对比，确实当前正在死循环的机器码，就是我们的js代码对应生成的。</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>//相关源码和参数：</div><div>d8.exe --print-bytecode --print-code  --module  text.js  //把js文件生成字节码和机器码</div><div><br/></div><div>function print(a){return 'hello'+a}</div><div>while(1){ print(88888888)}</div></div><div><br/></div><div><br/></div><div><span style="font-size: 21px;"><b>2.3 由此得出调试结论</b></span></div><div>JS的代码最终在经过AST bytecode后，最终是被动态的生成了对应平台的机器码。然后动态的执行。</div><div>执行的时候，在进入jS“内部虚拟机”执行后，堆栈的最终意义不大，看起来不直观了，都是纯汇编。（右下角对应起线程和堆栈）。</div><div><span style="color: rgb(51, 51, 51);"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="font-size: 12px;"><br/></span></span></span></div><div><br/></div><div><span style="font-size: 21px;"><b>2.4 堆上内存执行属性</b></span></div><div>Windows上的PE文件区分代码段（一般在.text section里）与数据段（一般在.data section和.rdata section）。Windows Vista和Windows 7 win10上打开DEP后，会进行系统级的监测，限制数据段执行代码。开启DEP后，数据段内存被认为是不可执行的，分配的空间必须标有PAGE_EXECUTE、PAGE_EXECUTE_READ、PAGE_EXECUTE_READWRITE或者PAGE_EXECUTE_WRITECOPY属性才可以执行。系统会认为可执行代码就应该保存到代码段，出现异常直接报错。此时需要使用VirtualAllocVirtualAlloc修改对应内存的属性。</div><div>冯·诺依曼体系结构的机器上，存储器既可以用于保存代码，也可以用于保存数据。代码和数据其实没有明显的界限，代码就是数据，数据可以看作代码来执行。在堆上和数据段里放代码，就像有些时候C的switch...case语句会被编译为基于表的跳转，而这个跳转表就夹杂在指令序列中一样。引申开来，有时候我们会希望根据运行时的某些特定条件来动态生成些效率较高的、特化的代码，而不是使用通用但效率较低的代码，这个时候就需要用到动态代码生成技术。 例如把正则表达式动态编译为紧凑高效的机器码toka。Google V8里面就有这样的正则表达式引擎编译器。</div><div><br/></div><div>针对本次的调试例子。</div><div>当前运行的RIP（EIP）是处在堆上，其内存属性是什么?用windbg分析如下。</div><div>当前运行的RIP，起对应的机器码是 49 3b a5 f0 ****</div><div>其内存属性是PAGE_EXECUTE_READ。</div><div><img src="v8_编译执行（一）_v8是如何动态运行js对应的机器码_files/Image [1].png" type="image/png" style="height: auto;"/></div><div><br/></div><div><span style="font-size: 21px;"><b>2.5 其它可以继续调试分析的</b></span></div><div>以上只是最简单的流程分析，更复杂的分析还有以下:</div><div>运行时性能数据收集</div><div>JIT优化等</div><div>JS回调外部注入函数</div><div>隐藏其中的GC和内存分布管理</div><div><br/></div><div><span style="font-size: 21px;"><b>2.6 一个其他的例子</b></span></div><div>演示动态生成机器码然后执行</div><div>//其他类似的例子     <span style="color: rgb(255, 0, 0);"><b>注意开启DEP以后会执行失败。</b></span></div><div><a href="http://rednaxelafx.iteye.com/blog/428780">http://rednaxelafx.iteye.com/blog/428780</a></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.148438);"><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#include &lt;stdio.h&gt;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">typedef int (*puts_ptr)(const char*);</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">typedef void (*myfunc_ptr)(puts_ptr);</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">/*</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">void foo(puts_ptr p) {</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">    p(&quot;greetings from generated code!&quot;);</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">}</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">*/</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">/* code as string in data section:</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">offset | bytes (in hex) | mnemonics</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">00     | 55             | push EBP</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">01     | 8BEC           | mov  EBP, ESP</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">03     | E8 00000000    | call next instruction</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">08     | 58             | pop  EAX</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">09     | 83C0 0D        | add  EAX, 0D</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">12     | 50             | push EAX</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">13     | FF55 08        | call dword ptr [EBP + 8]</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">16     | 83C4 04        | add  ESP, 04</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">19     | 5D             | pop  EBP</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">20     | C3             | ret</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">*/</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">int main() {</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">    myfunc_ptr pMyfunc;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">    puts_ptr pPuts = &amp;puts;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">    const char* code = &quot;\x55\x8B\xEC\xE8\x00\x00\x00\x00&quot;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">                       &quot;\x58\x83\xC0\x0D\x50\xFF\x55\x08&quot;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">                       &quot;\x83\xC4\x04\x5D\xC3&quot;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">                       &quot;greetings from generated code!&quot;;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">    pMyfunc = (myfunc_ptr)code;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">    pMyfunc(pPuts);</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">    return 0;</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">}</span></span></span></div></div><div><span style="color: rgb(255, 0, 0);"><b>开启对应进程的DEP后，会无法正常运行</b></span></div><div><img src="v8_编译执行（一）_v8是如何动态运行js对应的机器码_files/Image [2].png" type="image/png" style="height: auto;"/></div><div><img src="v8_编译执行（一）_v8是如何动态运行js对应的机器码_files/Image [3].png" type="image/png" style="height: auto;"/></div><div><b><span style="font-size: 24px;">3 总结</span></b></div><div>在c++程序中，调用V8相关接口，先把脚本准备（解析编译） 好。</div><div>最后会调用脚本接口<span style="color: rgb(255, 0, 0);"><b>run</b></span>，实际上就是在<span style="color: rgb(255, 0, 0);"><b>本线程</b></span>中继续执行，直接通过stud函数入口，调用机器码（堆上的机器码）。</div><div>然后在js的虚拟机环境中，运行生成的机器码，返回c++前，由js虚拟机管理堆栈。（实际上类似于<span style="color: rgb(255, 0, 0);"><b>2.6</b></span> 中一种动态生成机器码，运行<span style="color: rgb(255, 0, 0);"><b>shellcode</b></span>）</div><div><br/></div><div>后续可以继续摸索:</div><div>1.这里应该是有调试机制的，因为chrome开发者工具是可以单步调试的。</div><div>2.js本身应该也是支持调试特性。  </div><div><br/></div><div><br/></div><div><hr/></div><div><br/></div></span>
</div></body></html> 