<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2436"/>

<div>
<span><div><div style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div>原文：<a href="https://blog.csdn.net/CJF_iceKing/article/details/77823004">https://blog.csdn.net/CJF_iceKing/article/details/77823004</a><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;"><span style="font-family: 微软雅黑;">     </span></span></span></div><div><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;"><span style="font-family: 微软雅黑;"><br/></span></span></span></div><div><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;"><span style="font-family: 微软雅黑;">不少程序员在编写程序的时候，会使用函数内静态(<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">static</span></code>)变量，既能满足函数内这个变量可以持久的记录某些信息，又使其访问范围的控制局限于函数内。但<strong style="box-sizing: border-box; outline: 0px; font-weight: 700; word-break: break-all;">函数内静态类对象初始化是非线程安全的</strong>。</span></span></span></div></div><h3 style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 16px; font-size: 22px; color: rgb(79, 79, 79); font-weight: 700; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="t0" style="box-sizing: border-box; outline: 0px; color: rgb(78, 161, 219); text-decoration: none; cursor: pointer; word-break: break-all;"></a><span style="font-family: 微软雅黑;">问题背景</span></h3><p style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">在我们产品中对log4cxx做了一些简单的封装 （采用VS2005编译），其中会调用到<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">getWarn</span></code>这个接口。由于这个函数存在非线程安全的问题，导致程序Crash。为了更好的描述问题，博主后面采用一个简单的例子去做分析：为什么这个是非线程安全的。</span></p><div style="box-sizing: border-box; outline: 0px; padding: 8px 16px 4px 56px; margin: 0px 0px 24px; position: relative; font-size: 14px; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); border: none; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; outline: 0px; display: block; padding: 0px; color: rgb(0, 0, 0); font-size: 14px; background-color: rgb(246, 248, 250); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; overflow-x: auto;"><span style="font-family: 微软雅黑;">LevelPtr Level<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">::getWarn</span>() {<br/>
    static LevelPtr level(<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">new</span> Level(Level<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">::WARN_INT</span>, LOG4CXX_STR(<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 153, 0);">&quot;WARN&quot;</span>), <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">4</span>));<br/>
    <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">return</span> level;</span></code><div><span style="font-family: 微软雅黑;"><span style="background-color: rgb(246, 248, 250);">}</span></span></div></div><div><span style="font-family: 微软雅黑;"><br/></span></div><div style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 16px; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><h3 style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 16px; font-size: 22px; color: rgb(79, 79, 79); font-weight: 700; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">例子</span></h3><p style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">这里们写了一段样例代码，采用<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">VS2005</span></code>，为了避免程序被优化，博主采用的是<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">Debug</span></code>模式编译。</span></p><div style="box-sizing: border-box; outline: 0px; padding: 8px 16px 4px 56px; margin: 0px 0px 24px; position: relative; background-color: rgb(246, 248, 250); border: none; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; outline: 0px; display: block; padding: 0px; color: rgb(0, 0, 0); font-size: 14px; background-color: rgb(246, 248, 250); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; overflow-x: auto;"><span style="font-family: 微软雅黑;"><span style="box-sizing: border-box; outline: 0px;"><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">class</span> <span style="box-sizing: border-box; outline: 0px; color: rgb(79, 79, 79);">TestObject</span><br/>
{</span><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">public</span>:<br/>
    <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">int</span> m_iVal;<br/>
    TestObject()<br/>
    {<br/>
        m_iVal = <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">4</span>;<br/>
    }<br/>
};<br/><br/>
TestObject TestFunction()<br/>
{<br/>
    <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">static</span> TestObject obj;<br/>
    <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">return</span> obj;</span></code><div><span style="font-family: 微软雅黑;"><span style="font-size: 14px;"><span style="background-color: rgb(246, 248, 250);">}</span></span></span></div></div></div><div style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;"><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">以上代码简单来说，就是返回一个</span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">TestObject</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">的类对象。</span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">TestFunction</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">中永远返回一个静态对象</span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">obj</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">。 那么现在重点来了，你必须知道两点： <br style="box-sizing: border-box; outline: 0px; word-break: break-all;"/>
1. obj是在函数</span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">TestFunction</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">第一次被调用的时候才会调用构造函数 </span></span></span><div><span style="font-family: 微软雅黑;"><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">2. </span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">obj</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">在应用程序启动的时候，</span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">obj</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">对象内存中的值都为</span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">0</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">。并且这里的</span></span><code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">obj</span></code><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;">在初始化的时候（这里可以认为调用构造函数）是非线程安全的。</span></span></span></div><div><span style="font-family: 微软雅黑;"><span style="color: rgb(79, 79, 79);"><span style="font-size: 16px;"><br/></span></span></span></div><div><h3 style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 16px; font-size: 22px; color: rgb(79, 79, 79); font-weight: 700; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">分析非线程安全</span></h3><p style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">要分析这个问题，我们得通过VS的反汇编来查看，我在以下的代码中加了注释来直接解释这个问题。</span></p><div style="box-sizing: border-box; outline: 0px; padding: 8px 16px 4px 56px; margin: 0px 0px 24px; position: relative; background-color: rgb(246, 248, 250); border: none; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; outline: 0px; display: block; padding: 0px; color: rgb(0, 0, 0); font-size: 14px; background-color: rgb(246, 248, 250); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; overflow-x: auto;"><span style="font-family: 微软雅黑;">TestObject <span style="box-sizing: border-box; outline: 0px;">TestFunction()</span><br/>
{<br/>
0000000140001800  mov         qword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[rsp+8]</span>,rcx <br/>
0000000140001805  push        rdi <br/>
0000000140001806  <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">sub</span>         rsp,30h <br/>
000000014000180A  mov         rdi,rsp <br/>
000000014000180D  mov         rcx,0Ch <br/>
0000000140001817  mov         eax,0CCCCCCCCh <br/>
000000014000181C  rep stos    dword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[rdi]</span> <br/>
000000014000181E  mov         rcx,qword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[rsp+40h]</span> <br/>
0000000140001823  mov         qword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[rsp+20h]</span>,0FFFFFFFFFFFFFFFEh <br/>
    <span style="box-sizing: border-box; outline: 0px;">static</span> TestObject obj;<br/><span style="box-sizing: border-box; outline: 0px; color: rgb(136, 0, 0);">//===========================</span><br/>
这个地方从内存中读取一个值，可以理解为编译器给程序自动加了一个变量<span style="box-sizing: border-box; outline: 0px;">bInit(判断obj对象是否初始化了，bInit初始值为<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">0</span>)</span>，将bInit读取到eax，然后判断为1表示已经初始化，则直接返回对象；如果为0，则按顺序继续执行。<br/><span style="box-sizing: border-box; outline: 0px; color: rgb(136, 0, 0);">//===========================</span><br/>
000000014000182C  mov         eax,dword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[$S1 (14000F2A4h)]</span> <br/>
0000000140001832  and         eax,1 <br/>
0000000140001835  test        eax,eax <br/>
0000000140001837  jne         TestFunction+55h (140001855h) <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(136, 0, 0);">//===========================</span><br/>
将bInit值设置为1， 并且调用obj构造函数, 完成对象初始化<br/><span style="box-sizing: border-box; outline: 0px; color: rgb(136, 0, 0);">//===========================</span><br/>
0000000140001839  mov         eax,dword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[$S1 (14000F2A4h)]</span> <br/>
000000014000183F  or          eax,1 <br/>
0000000140001842  mov         dword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[$S1 (14000F2A4h)]</span>,eax <br/>
0000000140001848  lea         rcx,<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[obj (14000F2A0h)]</span> <br/>
000000014000184F  call        TestObject<span style="box-sizing: border-box; outline: 0px;">::TestObject (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">1400011</span>EFh) <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">0000000140001854</span>  nop             <br/>
    return obj;</span><br/>
0000000140001855  mov         rax,qword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[rsp+40h]</span> <br/>
000000014000185A  mov         ecx,dword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[obj (14000F2A0h)]</span> <br/>
0000000140001860  mov         dword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[rax]</span>,ecx <br/>
0000000140001862  mov         rax,qword ptr <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 136, 0);">[rsp+40h]</span> </span></code><div><span style="font-family: 微软雅黑;"><span style="font-size: 14px;"><span style="background-color: rgb(246, 248, 250);">}</span></span></span></div></div></div><div><p style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">看了以上汇编和解释之后，大家应该能明白这里存在一个Race Condition。当多个线程，同时调用<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">TestFunction</span></code>这个函数，当线程A执行完<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">0000000140001842 mov dword ptr [$S1 (14000F2A4h)],eax</span></code>, 线程B刚好进入<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">TestFunction</span></code>执行，以为obj已经初始化了，则直接返回对象，其实这个时候对象内部的<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">m_iVal</span></code>为0， 并非程序员的本意。</span></p><h3 style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 16px; font-size: 22px; color: rgb(79, 79, 79); font-weight: 700; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="t3" style="box-sizing: border-box; outline: 0px; color: rgb(78, 161, 219); text-decoration: none; cursor: pointer; word-break: break-all;"></a><span style="font-family: 微软雅黑;">C++ 11线程安全</span></h3><p style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">博主采用了VS2015 （支持C++ 11）编译了以上的代码，得到如下汇编, 其通过<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">_Init_thread_header</span></code>和<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">_Init_thread_footer</span></code>来保证局部的静态对象的初始化线程安全。具体实现google并没有找到，有兴趣的同学可以汇编跟进去再研究研究。</span></p><div style="box-sizing: border-box; outline: 0px; padding: 8px 16px 4px 56px; margin: 0px 0px 24px; position: relative; background-color: rgb(246, 248, 250); border: none; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; outline: 0px; display: block; padding: 0px; color: rgb(0, 0, 0); font-size: 14px; background-color: rgb(246, 248, 250); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; overflow-x: auto;"><span style="font-family: 微软雅黑;">TestObject TestFunction()<br/>
{<br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411830  mov         qword ptr [rsp+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">8</span>],rcx <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411835  push        rbp <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411836  push        rdi <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411837  sub         rsp,<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">108</span>h <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41183E  lea         rbp,[rsp+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">20</span>h] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411843  mov         rdi,rsp <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411846  mov         ecx,<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">42</span>h <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41184B  mov         eax,<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">0</span>CCCCCCCCh <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411850  rep stos    dword ptr [rdi] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411852  mov         rcx,qword ptr [rsp+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">128</span>h] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41185A  mov         qword ptr [rbp+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">0</span>C8h],<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">0F</span>FFFFFFFFFFFFFFEh <br/>
    <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">static</span> TestObject obj;<br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411865  mov         eax,<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">104</span>h <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41186A  mov         eax,eax <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41186C  mov         ecx,dword ptr [_tls_index (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41C1E0h)] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411872  mov         rdx,qword ptr gs:[<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">58</span>h] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41187B  mov         rcx,qword ptr [rdx+rcx*<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">8</span>] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41187F  mov         eax,dword ptr [rax+rcx] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411882  cmp         dword ptr [obj+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">4</span>h (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41C180h)],eax <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411888  jle         TestFunction+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">88</span>h (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F4118B8h) <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41188A  lea         rcx,[obj+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">4</span>h (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41C180h)] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411891  call        _Init_thread_header (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41101Eh) <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F411896  cmp         dword ptr [obj+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">4</span>h (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41C180h)],<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">0F</span>FFFFFFFh <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41189D  jne         TestFunction+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">88</span>h (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F4118B8h) <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F41189F  lea         rcx,[obj (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41C17Ch)] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118A6  call        TestObject::TestObject (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F411028h) <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118AB  nop <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118AC  lea         rcx,[obj+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">4</span>h (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41C180h)] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118B3  call        _Init_thread_footer (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F411078h) <br/>
    <span style="box-sizing: border-box; outline: 0px; color: rgb(0, 0, 136);">return</span> obj;<br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118B8  mov         rax,qword ptr [rbp+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">100</span>h] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118BF  mov         ecx,dword ptr [obj (<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">07F</span>F65F41C17Ch)] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118C5  mov         dword ptr [rax],ecx <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118C7  mov         rax,qword ptr [rbp+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">100</span>h] <br/>
}<br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118CE  lea         rsp,[rbp+<span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">0E8</span>h] <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118D5  pop         rdi <br/><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118D6  pop         rbp </span></code><div><span style="font-family: 微软雅黑;"><span style="font-size: 14px;"><span style="background-color: rgb(246, 248, 250);"><span style="box-sizing: border-box; outline: 0px; color: rgb(0, 102, 102);">00007F</span>F65F4118D7  ret  </span></span></span></div></div></div><div><p style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); font-weight: 400; text-align: justify; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑;">这个功能在VS2015中默认开启，如果想要禁用这个功能, 可以添加额外的编译选项<code style="box-sizing: border-box; outline: 0px; font-size: 14px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 4px 2px 0px; word-break: break-all;"><span style="font-family: 微软雅黑;">/Zc:threadSafeInit-</span></code>。 详细的可以参考<a href="https://docs.microsoft.com/en-us/cpp/build/reference/zc-threadsafeinit-thread-safe-local-static-initialization" rel="nofollow" style="box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; word-break: break-all;" target="_blank">/Zc:threadSafeInit (Thread-safe Local Static Initialization)</a>。</span></p><h3 style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 16px; font-size: 22px; color: rgb(79, 79, 79); font-weight: 700; word-break: break-all; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a name="t4" style="box-sizing: border-box; outline: 0px; color: rgb(78, 161, 219); text-decoration: none; cursor: pointer; word-break: break-all;"></a><span style="font-family: 微软雅黑;">总结</span></h3><ol style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style: none; word-break: break-all; color: rgb(51, 51, 51); font-size: 14px; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 0px 40px; list-style-type: decimal; word-break: break-all;"><span style="font-family: 微软雅黑;">在C++ 11之前，尽量避免使用函数内静态对象。</span></li><li style="box-sizing: border-box; outline: 0px; padding: 0px; margin: 8px 0px 0px 40px; list-style-type: decimal; word-break: break-all;"><span style="font-family: 微软雅黑;">尽量在条件允许的情况下，将编译器升级到支持C++ 11的VS2015或者以上吧。</span></li></ol></div></div></div></div></span>
</div></body></html> 